<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة البيانات الشخصية</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>مرحبًا بك في صفحتك الشخصية</h1>
    </header>
    <main>
        <section>
            <h2>الصورة الشخصية</h2>
            <img src="" alt="صورتك الشخصية" id="profileImage">
            <input type="file" accept="image/*" id="imageUpload">
        </section>
        <section>
            <h2>بياناتك الشخصية</h2>
            <label for="name">الاسم:</label>
            <input type="text" id="name">
            <label for="email">البريد الإلكتروني:</label>
            <input type="email" id="email" disabled>
            <label for="nationality">الجنسية:</label>
            <input type="text" id="nationality">
            <label for="city">المدينة:</label>
            <input type="text" id="city">
            <label for="experience">عدد سنوات الخبرة:</label>
            <input type="text" id="experience">
            <!-- إضافة حقل لتحميل صور الخدمات السابقة -->
            <label for="previousServices">صور الخدمات السابقة:</label>
            <input type="file" accept="image/*" multiple id="previousServices">
            <button id="saveChanges">حفظ التغييرات</button>
        </section>
        <a href="#" id="logout">تسجيل الخروج</a>
        <button id="login" style="display: none;">تسجيل الدخول</button> <!-- زر تسجيل الدخول -->
    </main>
    <footer>
        <p>&copy; ٢٠٢٤ خدمات البناء</p>
    </footer>

    <!-- Firebase SDK Script Tags -->
    <script type="module">
        // Import the necessary modules from Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getAuth, updateProfile } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const storage = getStorage(app);

        // Set user's profile data
        const currentUserData = getAuth().currentUser;
        document.getElementById('name').value = currentUserData.displayName || '';
        document.getElementById('email').value = currentUserData.email || '';

        // Save changes button click event
        document.getElementById('saveChanges').addEventListener('click', async () => {
            const name = document.getElementById('name').value;
            const nationality = document.getElementById('nationality').value;
            const city = document.getElementById('city').value;
            const experience = document.getElementById('experience').value;
            const image = document.getElementById('imageUpload').files[0];

            // Update user's display name and additional data
            try {
                await updateProfile(auth.currentUser, {
                    displayName: name,
                    nationality: nationality,
                    city: city,
                    experience: experience
                });
                console.log("User profile updated successfully");

                // Upload image to storage (if provided)
                if (image) {
                    const storageRef = ref(storage, `profileImages/${auth.currentUser.uid}/${image.name}`);
                    await uploadBytes(storageRef, image);
                    const downloadURL = await getDownloadURL(storageRef);
                    console.log('File available at', downloadURL);
                    // Update user's profile image URL
                    await updateProfile(auth.currentUser, { photoURL: downloadURL });
                    console.log("User profile image URL updated successfully");
                    document.getElementById('profileImage').src = downloadURL;
                }
            } catch (error) {
                console.error("Error updating user profile:", error);
            }
        });

        // Logout button click event
        document.getElementById('logout').addEventListener('click', () => {
            auth.signOut().then(() => {
                // Sign-out successful
                console.log("User signed out successfully");
                window.location.href = 'login.html';
            }).catch((error) => {
                // An error happened
                console.error("Error signing out:", error);
            });
        });

        // Display profile image when user selects a file
        const imageUpload = document.getElementById('imageUpload');
        const profileImage = document.getElementById('profileImage');
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Listen for authentication state changes
        auth.onAuthStateChanged((user) => {
            const loginButton = document.getElementById('login');
            if (!user) {
                // User is not signed in, show login button
                loginButton.style.display = 'block';
            }
        });

        // Handle login button click event
        document.getElementById('login').addEventListener('click', () => {
            // Implement your login logic here
            // For example, you can redirect the user to a login page or display a login modal
            // You can use Firebase signInWithPopup or signInWithRedirect methods to handle login
        });
    </script>
</body>
</html>
